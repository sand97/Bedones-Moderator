// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Provider {
  FACEBOOK
  INSTAGRAM
}

enum SubscriptionTier {
  FREE
  STARTER
  PRO
  BUSINESS
}

enum PaymentProvider {
  STRIPE
  NOTCHPAY
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model User {
  id                String        @id @default(cuid())
  email             String?       @unique
  name              String?
  image             String?
  emailVerified     Boolean       @default(false)
  facebookId        String?       @unique
  instagramId       String?       @unique
  accessToken       String? // Encrypted access token
  accessTokenExpiry DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  pages             Page[]
  sessions          Session[]
  accounts          Account[]
  subscription      Subscription?
  usageTracking     UsageTracking[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Account {
  id                String   @id @default(cuid())
  userId            String
  accountId         String
  providerId        String
  accessToken       String?
  refreshToken      String?
  idToken           String?
  expiresAt         DateTime?
  password          String?
  scope             String?
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([providerId, accountId])
  @@index([userId])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
}

model Page {
  id                String        @id // Page/Account ID (Facebook Page ID or Instagram Account ID)
  provider          Provider      @default(FACEBOOK)
  name              String
  username          String? // Instagram username (null for Facebook)
  profilePictureUrl String? // Profile picture (mainly for Instagram)
  followersCount    Int? // For Instagram
  accessToken       String // Encrypted page-specific access token
  userId            String
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  settings          PageSettings?
  posts             Post[]
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([userId])
  @@index([provider])
}

model PageSettings {
  id                        String    @id @default(cuid())
  pageId                    String    @unique
  page                      Page      @relation(fields: [pageId], references: [id], onDelete: Cascade)
  undesiredCommentsEnabled  Boolean   @default(false)
  undesiredCommentsAction   String    @default("hide") // "hide" or "delete"
  spamDetectionEnabled      Boolean   @default(false)
  spamAction                String    @default("delete") // "hide" or "delete"
  intelligentFAQEnabled     Boolean   @default(false)
  faqRules                  FAQRule[]
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
}

model FAQRule {
  id             String       @id @default(cuid())
  pageSettingsId String
  pageSettings   PageSettings @relation(fields: [pageSettingsId], references: [id], onDelete: Cascade)
  assertion      String // Trigger condition (e.g., "If user asks for phone number")
  response       String // AI response template (e.g., "Reply 657 80 80 80")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([pageSettingsId])
}

model Comment {
  id               String   @id // Facebook Comment ID
  postId           String
  post             Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  pageId           String
  message          String
  fromId           String // Facebook User ID
  fromName         String // Facebook User Name
  createdTime      DateTime
  action           String // "none", "hide", "delete", "reply"
  actionReason     String? // AI explanation
  replyMessage     String? // The actual reply message sent by AI (for action="reply")
  permalinkUrl     String? // URL to the comment on Facebook
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([postId])
  @@index([pageId])
  @@index([fromId])
  @@index([action])
  @@index([createdTime])
}

model Post {
  id           String    @id // Post ID (Facebook Post ID or Instagram Media ID)
  pageId       String
  page         Page      @relation(fields: [pageId], references: [id], onDelete: Cascade)
  message      String? // Post message/caption
  permalinkUrl String? // URL to the post
  comments     Comment[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([pageId])
}

model Subscription {
  id                    String           @id @default(cuid())
  userId                String           @unique
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  tier                  SubscriptionTier @default(FREE)
  planName              String? // "Starter", "Pro", "Business"

  // Stripe Integration
  stripePriceId         String?
  stripeProductId       String?
  stripeSubscriptionId  String?
  stripeCustomerId      String?

  // NotchPay Integration
  notchpayCustomerEmail String?
  notchpayCustomerPhone String?

  // Usage limits (per month)
  monthlyCommentLimit   Int              @default(100) // FREE = 100, STARTER = 1000, PRO = 5000, BUSINESS = 20000
  currentMonthUsage     Int              @default(0)
  usageResetDate        DateTime? // When to reset monthly usage

  expiresAt             DateTime? // null for FREE tier
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  payments              Payment[]

  @@index([userId])
  @@index([tier])
}

model Payment {
  id                    String          @id @default(cuid())
  subscriptionId        String
  subscription          Subscription    @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  amount                Float
  currency              String          @default("XAF") // FCFA (West/Central Africa) or USD
  status                PaymentStatus   @default(PENDING)
  paymentProvider       PaymentProvider

  // Stripe Fields
  stripePaymentIntentId String?
  stripeChargeId        String?

  // NotchPay Fields
  notchpayTransactionId String?
  notchpayReference     String?

  metadata              String? // JSON string for additional data
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  @@index([subscriptionId])
  @@index([status])
  @@index([stripePaymentIntentId])
  @@index([notchpayTransactionId])
}

model UsageTracking {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date              DateTime @default(now()) // Date of usage

  // AI Usage
  commentsAnalyzed  Int      @default(0) // Number of comments analyzed by AI
  tokensUsed        Int      @default(0) // Approximate tokens consumed

  // Platform breakdown
  facebookComments  Int      @default(0)
  instagramComments Int      @default(0)

  // Cost tracking (for analytics)
  estimatedCost     Float    @default(0.0) // In USD

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([date])
  @@unique([userId, date])
}
