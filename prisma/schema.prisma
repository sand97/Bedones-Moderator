// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

enum Provider {
  FACEBOOK
  INSTAGRAM
}

model User {
  id                String    @id @default(cuid())
  email             String?   @unique
  name              String?
  image             String?
  emailVerified     Boolean   @default(false)
  facebookId        String?   @unique
  instagramId       String?   @unique
  accessToken       String? // Encrypted access token
  accessTokenExpiry DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  pages             Page[]
  sessions          Session[]
  accounts          Account[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Account {
  id                String   @id @default(cuid())
  userId            String
  accountId         String
  providerId        String
  accessToken       String?
  refreshToken      String?
  idToken           String?
  expiresAt         DateTime?
  password          String?
  scope             String?
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([providerId, accountId])
  @@index([userId])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
}

model Page {
  id                String        @id // Page/Account ID (Facebook Page ID or Instagram Account ID)
  provider          Provider      @default(FACEBOOK)
  name              String
  username          String? // Instagram username (null for Facebook)
  profilePictureUrl String? // Profile picture (mainly for Instagram)
  followersCount    Int? // For Instagram
  accessToken       String // Encrypted page-specific access token
  userId            String
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  settings          PageSettings?
  posts             Post[]
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([userId])
  @@index([provider])
}

model PageSettings {
  id                        String    @id @default(cuid())
  pageId                    String    @unique
  page                      Page      @relation(fields: [pageId], references: [id], onDelete: Cascade)
  undesiredCommentsEnabled  Boolean   @default(false)
  undesiredCommentsAction   String    @default("hide") // "hide" or "delete"
  spamDetectionEnabled      Boolean   @default(false)
  spamAction                String    @default("delete") // "hide" or "delete"
  intelligentFAQEnabled     Boolean   @default(false)
  faqRules                  FAQRule[]
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
}

model FAQRule {
  id             String       @id @default(cuid())
  pageSettingsId String
  pageSettings   PageSettings @relation(fields: [pageSettingsId], references: [id], onDelete: Cascade)
  assertion      String // Trigger condition (e.g., "If user asks for phone number")
  response       String // AI response template (e.g., "Reply 657 80 80 80")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([pageSettingsId])
}

model Comment {
  id               String   @id // Facebook Comment ID
  postId           String
  post             Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  pageId           String
  message          String
  fromId           String // Facebook User ID
  fromName         String // Facebook User Name
  createdTime      DateTime
  action           String // "none", "hide", "delete", "reply"
  actionReason     String? // AI explanation
  replyMessage     String? // The actual reply message sent by AI (for action="reply")
  permalinkUrl     String? // URL to the comment on Facebook
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([postId])
  @@index([pageId])
  @@index([fromId])
  @@index([action])
  @@index([createdTime])
}

model Post {
  id           String    @id // Post ID (Facebook Post ID or Instagram Media ID)
  pageId       String
  page         Page      @relation(fields: [pageId], references: [id], onDelete: Cascade)
  message      String? // Post message/caption
  permalinkUrl String? // URL to the post
  comments     Comment[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([pageId])
}
